name: Deploy Complete Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  setup-cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-infra
          path: infra

      - name: Setup Kubernetes Tools
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl

      - name: Create Kind Cluster and Registry
        run: |
          cd infra
          docker run -d --restart=always -p 5000:5000 --name kind-registry registry:2

          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          name: ticketboard-cluster
          containerdConfigPatches:
          - |-
            [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
              endpoint = ["http://kind-registry:5000"]
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30000
              hostPort: 30000
              protocol: TCP
            - containerPort: 30001
              hostPort: 30001
              protocol: TCP
          EOF

          docker network connect kind kind-registry || true
          kubectl cluster-info

  deploy-database:
    runs-on: ubuntu-latest
    needs: setup-cluster

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-infra
          path: infra

      - name: Deploy Database
        run: |
          cd infra
          kubectl apply -k k8s/base/
          kubectl apply -k k8s/database/ -n ticketboard
          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=180s
          echo "âœ… Database deployed successfully"

  build-and-deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-database

    steps:
      - name: Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-backend
          path: backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: Build and Push Backend Image
        run: |
          cd backend
          docker build -t localhost:5000/ticketboard-backend:latest .
          docker push localhost:5000/ticketboard-backend:latest
          echo "âœ… Backend image built and pushed"

      - name: Deploy Backend to Kubernetes
        run: |
          # Usar los manifests del infra repo
          kubectl apply -k infra/k8s/backend/ -n ticketboard
          echo "â³ Waiting for backend to be ready..."
          kubectl wait --for=condition=ready pod -l app=backend -n ticketboard --timeout=180s
          echo "âœ… Backend deployed successfully"

  build-and-deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-and-deploy-backend

    steps:
      - name: Checkout Frontend
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-frontend
          path: frontend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Frontend
        run: |
          cd frontend
          VITE_API_URL=http://backend-service:8080 npm run build
          echo "âœ… Frontend built successfully"

      - name: Build and Push Frontend Image
        run: |
          cd frontend
          docker build -t localhost:5000/ticketboard-frontend:latest .
          docker push localhost:5000/ticketboard-frontend:latest
          echo "âœ… Frontend image built and pushed"

      - name: Deploy Frontend to Kubernetes
        run: |
          kubectl apply -k infra/k8s/frontend/ -n ticketboard
          echo "â³ Waiting for frontend to be ready..."
          kubectl wait --for=condition=ready pod -l app=frontend -n ticketboard --timeout=180s
          echo "âœ… Frontend deployed successfully"

  verify-deployment:
    runs-on: ubuntu-latest
    needs: [ build-and-deploy-backend, build-and-deploy-frontend ]

    steps:
      - name: Verify Complete Deployment
        run: |
          echo "ðŸ” Verifying complete deployment..."
          kubectl wait --for=condition=ready --timeout=300s -n ticketboard --all pod

          echo "ðŸŽ‰ TICKETBOARD APPLICATION DEPLOYED SUCCESSFULLY!"
          echo ""
          echo "ðŸ“Š Deployment Status:"
          kubectl get all -n ticketboard

          echo ""
          echo "ðŸŒ Access Points:"
          echo "   Frontend: http://localhost:30000"
          echo "   Backend API: http://localhost:30001"
          echo "   PostgreSQL: localhost:5432"

          echo ""
          echo "ðŸš€ Application is ready to use!"
