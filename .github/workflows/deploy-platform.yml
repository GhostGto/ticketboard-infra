name: Deploy Complete Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  setup-cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Setup Kubernetes Tools
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl

      - name: Create Kind Cluster
        run: |
          # Limpiar clusters existentes primero
          kind delete cluster --name ticketboard 2>/dev/null || true
          kind delete cluster --name ticketboard-cluster 2>/dev/null || true

          # Crear registry
          docker run -d --restart=always -p 5000:5000 --name kind-registry registry:2

          # Crear cluster con nombre EST√ÅNDAR
          cat <<EOF | kind create cluster --name ticketboard --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          name: ticketboard
          containerdConfigPatches:
          - |-
            [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
              endpoint = ["http://kind-registry:5000"]
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30000
              hostPort: 30000
              protocol: TCP
            - containerPort: 30001
              hostPort: 30001
              protocol: TCP
          EOF

          # Conectar registry
          docker network connect kind kind-registry || true

          # Configurar kubectl
          kind export kubeconfig --name ticketboard

          # Verificar
          kubectl cluster-info
          kubectl get nodes

  deploy-database:
    runs-on: ubuntu-latest
    needs: setup-cluster

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Configure Kubectl
        run: |
          # Usar el nombre EST√ÅNDAR
          kind export kubeconfig --name ticketboard
          kubectl config use-context kind-ticketboard
          kubectl cluster-info

      - name: Deploy Database
        run: |
          kubectl apply -k k8s/base/ --validate=false
          kubectl apply -k k8s/database/ -n ticketboard --validate=false
          kubectl wait --for=condition=ready pod -l app=postgres -n ticketboard --timeout=180s

  build-backend:
    runs-on: ubuntu-latest
    needs: deploy-database

    steps:
      - name: Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-backend
          path: backend

      - name: Configure Kubectl
        run: |
          kind export kubeconfig --name ticketboard

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Build Backend
        run: |
          cd backend
          npm ci
          docker build -t localhost:5000/ticketboard-backend:latest .
          docker push localhost:5000/ticketboard-backend:latest

  deploy-backend:
    runs-on: ubuntu-latest
    needs: build-backend

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Configure Kubectl
        run: |
          kind export kubeconfig --name ticketboard

      - name: Deploy Backend
        run: |
          kubectl apply -k k8s/backend/ -n ticketboard --validate=false
          kubectl wait --for=condition=ready pod -l app=backend -n ticketboard --timeout=180s

  build-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout Frontend
        uses: actions/checkout@v4
        with:
          repository: GhostGto/ticketboard-frontend
          path: frontend

      - name: Configure Kubectl
        run: |
          kind export kubeconfig --name ticketboard

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          VITE_API_URL=http://backend-service:8080 npm run build
          docker build -t localhost:5000/ticketboard-frontend:latest .
          docker push localhost:5000/ticketboard-frontend:latest

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-frontend

    steps:
      - name: Checkout Infra
        uses: actions/checkout@v4

      - name: Configure Kubectl
        run: |
          kind export kubeconfig --name ticketboard

      - name: Deploy Frontend
        run: |
          kubectl apply -k k8s/frontend/ -n ticketboard --validate=false
          kubectl wait --for=condition=ready pod -l app=frontend -n ticketboard --timeout=180s

  final-verification:
    runs-on: ubuntu-latest
    needs: [ deploy-backend, deploy-frontend ]

    steps:
      - name: Configure Kubectl
        run: |
          kind export kubeconfig --name ticketboard

      - name: Verify Deployment
        run: |
          kubectl get all -n ticketboard
          echo "üéâ DEPLOYMENT COMPLETED!"
