name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Kubernetes
        run: |
          kubectl config use-context docker-desktop
          kubectl create namespace ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Configure local registry secret
        run: |
          kubectl create secret docker-registry local-registry \
            --docker-server=host.docker.internal:5000 \
            --docker-username= \
            --docker-password= \
            --docker-email= \
            -n ticketboard --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Database
        run: |
          kubectl apply -f k8s/postgres-pvc.yaml
          kubectl apply -f k8s/postgres-deployment.yaml
          kubectl apply -f k8s/postgres-service.yaml

      - name: Wait for database
        run: |
          echo "⏳ Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if kubectl get pod -n ticketboard -l app=postgres -o jsonpath='{.items[0].status.phase}' 2>/dev/null | grep -q Running; then
              echo "✅ PostgreSQL is running"
              break
            fi
            echo "⏱️ Attempt $i/30 - Waiting for PostgreSQL..."
            sleep 10
          done

      - name: Deploy Backend and Frontend
        run: |
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/backend-service.yaml
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/frontend-service.yaml

      - name: Update images to use local registry
        run: |
          kubectl set image deployment/backend -n ticketboard backend=host.docker.internal:5000/ticketboard-backend:latest
          kubectl set image deployment/frontend -n ticketboard frontend=host.docker.internal:5000/ticketboard-frontend:latest

      - name: Wait for all services
        run: |
          echo "⏳ Waiting for all services to be ready..."
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=backend --no-headers | grep -q "Running"; do sleep 5; done'
          timeout 300s bash -c 'until kubectl get pods -n ticketboard -l app=frontend --no-headers | grep -q "Running"; do sleep 5; done'

      - name: Verify deployment
        run: |
          echo "✅ Deployment completed!"
          kubectl get all -n ticketboard
